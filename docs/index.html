<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cardiff EV Charging – P=10 Solution + Live Traffic</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 5;
      background: rgba(255,255,255,0.95);
      border: 1px solid #ddd; border-radius: 10px;
      padding: 10px 12px; width: 320px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.12);
    }
    .panel h3 { margin: 6px 0 8px; font-size: 14px; }
    .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .row input { transform: translateY(1px); }
    .legend { margin-top: 10px; font-size: 12px; line-height: 1.35; }
    .swatch { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 6px; border: 1px solid rgba(0,0,0,0.2); }
    .btn {
      display:inline-block; margin-top: 8px;
      background:#111827; color:#fff; border:none; border-radius:8px;
      padding:8px 10px; cursor:pointer; font-size:12px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .small { color:#374151; font-size:12px; }
    .status { margin-top: 6px; font-size: 12px; color:#111827; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Layers</h3>
    <div class="row"><input id="lyTraffic" type="checkbox" checked><label for="lyTraffic">Live traffic</label></div>
    <div class="row"><input id="lyLSOA" type="checkbox" checked><label for="lyLSOA">LSOA polygons (Cardiff)</label></div>
    <div class="row"><input id="lySupply" type="checkbox" checked><label for="lySupply">Existing chargers (OCM)</label></div>
    <div class="row"><input id="lyNew" type="checkbox" checked><label for="lyNew">New sites selected (P=10)</label></div>
    <div class="row"><input id="lyDemand" type="checkbox"><label for="lyDemand">Demand centroids (LSOA)</label></div>

    <h3 style="margin-top:10px;">Driver demo (optional)</h3>
    <div class="small">Click a charger/new site marker → set destination → then “Route with traffic”.</div>
    <button id="btnRoute" class="btn" disabled>Route with traffic (from my location)</button>
    <div id="status" class="status"></div>

    <div class="legend">
      <b>Legend</b><br/>
      <div><span class="swatch" style="background:#2563eb;"></span>Blue circles: existing chargers</div>
      <div><span class="swatch" style="background:#ef4444;"></span>Red markers: new sites (P=10)</div>
      <div><span class="swatch" style="background:#6b7280;"></span>Grey dots: demand (LSOA centroids)</div>
      <div style="margin-top:6px;"><span class="swatch" style="background:#93c5fd;"></span>LSOA boundary fill (light)</div>
      <div class="small" style="margin-top:6px;">
        Note: If you later add per-LSOA accessibility fields (e.g., dist_base_m, dist_opt_m),
        we can color polygons by service level.
      </div>
    </div>
  </div>

  <script>
    // ====== CHANGE THIS ======
    const GMAPS_KEY = "AIzaSyAUproFl8jRStUlFwOKbQ8yh2CjNJ_H2c4";

    // Data files (must be inside docs/ for GitHub Pages if you deploy /docs)
    const DATA = {
      lsoa:   "./data/processed/demand_lsoa_cardiff_exact.geojson",
      demand: "./data/processed/demand_points_cardiff_exact.geojson",
      supply: "./data/processed/supply_chargers_ocm.geojson",
      news:   "./data/processed/new_sites_p10.geojson"
    };

    // Map globals
    let map, info, trafficLayer;
    let lsoaLayer;
    let supplyMarkers = [];
    let demandMarkers = [];
    let newMarkers = [];
    let selectedDestination = null;

    // Directions (for "Route with traffic")
    let directionsService, directionsRenderer;

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function circleSymbol(fillColor, scale) {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor,
        fillOpacity: 0.9,
        strokeColor: "#ffffff",
        strokeOpacity: 1,
        strokeWeight: 1,
        scale
      };
    }

    async function loadGeoJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
      return await res.json();
    }

    function addPointMarkers(geojson, kind) {
      const feats = geojson.features || [];
      const markers = [];

      for (const f of feats) {
        if (!f.geometry) continue;
        const [lng, lat] = f.geometry.type === "Point" ? f.geometry.coordinates : [null, null];
        if (lat == null || lng == null) continue;

        let marker;
        if (kind === "supply") {
          marker = new google.maps.Marker({
            position: { lat, lng },
            icon: circleSymbol("#2563eb", 5),
            title: "Existing charger"
          });
          marker.addListener("click", () => {
            selectedDestination = marker.getPosition();
            info.setContent(`<b>Existing charger</b><br/>Destination set. You can route with traffic.`);
            info.open(map, marker);
            document.getElementById("btnRoute").disabled = false;
          });
        }

        if (kind === "demand") {
          const lsoa = (f.properties && (f.properties.LSOA21CD || f.properties.lsoa)) || "demand";
          marker = new google.maps.Marker({
            position: { lat, lng },
            icon: circleSymbol("#6b7280", 3),
            title: `Demand: ${lsoa}`,
            clickable: true
          });
          marker.addListener("click", () => {
            info.setContent(`<b>Demand centroid</b><br/>LSOA: ${lsoa}`);
            info.open(map, marker);
          });
        }

        if (kind === "new") {
          const sid = (f.properties && (f.properties.site_id || f.properties.id || f.properties.chosen_candidate_id)) || "";
          marker = new google.maps.Marker({
            position: { lat, lng },
            // Red "pin"
            icon: {
              path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
              fillColor: "#ef4444",
              fillOpacity: 0.95,
              strokeColor: "#ffffff",
              strokeWeight: 1,
              scale: 6
            },
            title: `NEW site (P=10) ${sid}`.trim()
          });
          marker.addListener("click", () => {
            selectedDestination = marker.getPosition();
            info.setContent(`<b>NEW site (P=10)</b><br/>id: ${sid || "(n/a)"}<br/>Destination set. You can route with traffic.`);
            info.open(map, marker);
            document.getElementById("btnRoute").disabled = false;
          });
        }

        if (marker) {
          marker.setMap(map);
          markers.push(marker);
        }
      }
      return markers;
    }

    function setMarkersVisible(markers, on) {
      for (const m of markers) m.setMap(on ? map : null);
    }

    function initLayersUI() {
      const lyTraffic = document.getElementById("lyTraffic");
      const lyLSOA    = document.getElementById("lyLSOA");
      const lySupply  = document.getElementById("lySupply");
      const lyNew     = document.getElementById("lyNew");
      const lyDemand  = document.getElementById("lyDemand");

      lyTraffic.addEventListener("change", () => trafficLayer.setMap(lyTraffic.checked ? map : null));
      lyLSOA.addEventListener("change", () => lsoaLayer.setMap(lyLSOA.checked ? map : null));
      lySupply.addEventListener("change", () => setMarkersVisible(supplyMarkers, lySupply.checked));
      lyNew.addEventListener("change", () => setMarkersVisible(newMarkers, lyNew.checked));
      lyDemand.addEventListener("change", () => setMarkersVisible(demandMarkers, lyDemand.checked));
    }

    async function initMap() {
      // Base map centered near Cardiff
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 51.4816, lng: -3.1791 },
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });

      info = new google.maps.InfoWindow();

      // Traffic layer (real-time traffic overlay)
      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      // LSOA polygons as a Data layer
      lsoaLayer = new google.maps.Data();
      lsoaLayer.setStyle({
        fillColor: "#93c5fd",
        fillOpacity: 0.12,
        strokeColor: "#2563eb",
        strokeOpacity: 0.8,
        strokeWeight: 1
      });
      lsoaLayer.setMap(map);

      lsoaLayer.addListener("click", (e) => {
        const p = e.feature.getProperty("LSOA21CD") || e.feature.getProperty("lsoa21cd") || "";
        const name = e.feature.getProperty("LSOA21NM") || e.feature.getProperty("lsoa21nm") || "";
        info.setContent(`<b>LSOA</b><br/>${p}<br/>${name}`);
        info.setPosition(e.latLng);
        info.open(map);
      });

      // Directions (traffic-aware)
      directionsService  = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });

      // Load data
      try {
        setStatus("Loading GeoJSON…");

        const [lsoa, demand, supply, news] = await Promise.all([
          loadGeoJSON(DATA.lsoa),
          loadGeoJSON(DATA.demand),
          loadGeoJSON(DATA.supply),
          loadGeoJSON(DATA.news)
        ]);

        // Add polygons
        lsoaLayer.addGeoJson(lsoa);

        // Fit bounds to LSOA
        const bounds = new google.maps.LatLngBounds();
        lsoaLayer.forEach((f) => {
          const geom = f.getGeometry();
          geom.forEachLatLng((latlng) => bounds.extend(latlng));
        });
        map.fitBounds(bounds);

        // Add markers
        supplyMarkers = addPointMarkers(supply, "supply");
        newMarkers    = addPointMarkers(news,   "new");
        demandMarkers = addPointMarkers(demand, "demand");
        setMarkersVisible(demandMarkers, false); // default off for clarity

        setStatus("Loaded. Toggle layers & click markers to interact.");
      } catch (err) {
        console.error(err);
        setStatus("Failed to load data. Check console & file paths.");
        alert(String(err));
      }

      // UI events
      initLayersUI();

      // Route button
      document.getElementById("btnRoute").addEventListener("click", async () => {
        if (!selectedDestination) return;

        setStatus("Getting your location…");
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            setStatus("Routing with traffic…");

            directionsService.route({
              origin,
              destination: selectedDestination,
              travelMode: google.maps.TravelMode.DRIVING,
              drivingOptions: {
                departureTime: new Date(),
                trafficModel: google.maps.TrafficModel.BEST_GUESS
              }
            }, (result, status) => {
              if (status !== "OK" || !result) {
                setStatus("Route failed: " + status);
                return;
              }
              directionsRenderer.setDirections(result);

              const leg = result.routes[0].legs[0];
              const durTraffic = leg.duration_in_traffic ? leg.duration_in_traffic.text : "(n/a)";
              setStatus(`ETA (traffic): ${durTraffic} | Distance: ${leg.distance.text}`);
            });
          },
          (err) => {
            setStatus("Geolocation denied/unavailable.");
            alert("Cannot access location: " + err.message);
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    // Load Google Maps JS dynamically (so you can keep one HTML file)
    (function loadGoogleMaps() {
      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&callback=initMap&v=weekly`;
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
