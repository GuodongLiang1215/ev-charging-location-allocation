<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cardiff EV Charging – Driver View (Traffic-aware)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    #map img { max-width: none !important; }

    .panel{
      position:absolute; top:12px; left:12px; z-index:5;
      background:rgba(255,255,255,0.96);
      border:1px solid #ddd; border-radius:12px;
      padding:12px; width:420px;
      box-shadow:0 6px 22px rgba(0,0,0,0.14);
    }
    .title{ font-size:20px; font-weight:700; margin:4px 0 10px; }
    .row{ display:flex; align-items:center; gap:10px; margin:8px 0; }
    .row input[type="checkbox"]{ transform: translateY(1px); }
    .small{ color:#374151; font-size:12px; line-height:1.35; }
    .hint{ margin-top:6px; font-size:12px; color:#6b7280; }
    .status{ margin-top:8px; font-size:12px; color:#111827; white-space:pre-wrap; }

    .inputRow{ display:flex; gap:10px; margin:6px 0 10px; }
    #q{
      flex:1; padding:10px 12px; border-radius:10px;
      border:1px solid #d1d5db; outline:none; font-size:14px;
    }
    #btnSearch{
      padding:10px 14px; border-radius:10px; border:0;
      background:#111827; color:#fff; font-weight:600; cursor:pointer;
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin:8px 0; }
    .btn{
      display:inline-block;
      background:#111827; color:#fff; border:none; border-radius:10px;
      padding:10px 12px; cursor:pointer; font-size:13px; font-weight:600;
    }
    .btn.secondary{ background:#6b7280; }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .divider{ height:1px; background:#e5e7eb; margin:10px 0; }

    .resultsHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:8px; }
    .resultsHead .left{ display:flex; align-items:center; gap:8px; }
    .badge{
      min-width:20px; height:20px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background:#eef2ff; color:#3730a3; font-size:12px; font-weight:700;
      padding:0 7px;
    }
    .sortBtns{ display:flex; gap:10px; }
    .sortBtn{
      border:1px solid #e5e7eb; background:#fff; color:#111827;
      border-radius:999px; padding:8px 10px; cursor:pointer; font-size:12px;
    }
    .sortBtn.active{
      background:#111827; color:#fff; border-color:#111827;
    }

    .list{
      margin-top:8px;
      max-height:260px;
      overflow:auto;
      border:1px solid #e5e7eb; border-radius:12px;
      background:#fff;
    }
    .item{
      padding:10px 12px;
      border-bottom:1px solid #f1f5f9;
      cursor:pointer;
    }
    .item:last-child{ border-bottom:0; }
    .item:hover{ background:#f8fafc; }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; }
    .name{ font-weight:700; font-size:13px; color:#111827; }
    .meta{ font-size:12px; color:#374151; margin-top:2px; }
    .pill{
      font-size:12px; font-weight:700;
      background:#ecfeff; color:#155e75;
      border:1px solid #cffafe; border-radius:999px;
      padding:4px 8px; white-space:nowrap;
      height: fit-content;
    }

    .legend{ margin-top:10px; font-size:12px; line-height:1.45; }
    .swatch{
      display:inline-block; width:10px; height:10px; border-radius:2px;
      margin-right:6px; border:1px solid rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="title">Driver view (Cardiff only)</div>

    <div class="inputRow">
      <input id="q" placeholder="Search address/place (e.g., CF10 3AT, 1 King Edward VII Ave)" />
      <button id="btnSearch">Search</button>
    </div>

    <div class="btnRow">
      <button id="btnMyLoc" class="btn secondary">Use my location</button>
      <button id="btnRecommend" class="btn">Recommend best chargers (ETA)</button>
    </div>

    <div class="row">
      <input id="unlock" type="checkbox" />
      <label for="unlock" class="small"><b>Unlock map</b> (allow pan/search outside Cardiff)</label>
    </div>

    <div class="divider"></div>

    <div class="row"><input id="lyTraffic" type="checkbox" checked><label for="lyTraffic">Live traffic</label></div>
    <div class="row"><input id="lySupply" type="checkbox" checked><label for="lySupply">Existing chargers</label></div>
    <div class="row"><input id="lyLSOA" type="checkbox"><label for="lyLSOA">LSOA boundary (optional)</label></div>

    <div id="status" class="status"></div>
    <div class="hint">Tip: traffic lines are clearer at zoom ≥ 12. Click on map to set origin if location is denied.</div>

    <div class="divider"></div>

    <div class="resultsHead">
      <div class="left">
        <b>Best options</b> <span id="count" class="badge">0</span>
      </div>
      <div class="sortBtns">
        <button id="sortEta" class="sortBtn active">Sort: ETA</button>
        <button id="sortDist" class="sortBtn">Sort: Distance</button>
      </div>
    </div>
    <div id="list" class="list">
      <div class="item" style="cursor:default;">
        <div class="name">No results yet.</div>
        <div class="meta">Set origin (search / my location / click map) → Recommend.</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="legend">
      <b>Legend</b><br/>
      <div><span class="swatch" style="background:#2563eb;"></span><b>Blue</b>: existing chargers (bigger + thick white outline)</div>
      <div><span class="swatch" style="background:#93c5fd;"></span><b>LSOA</b>: boundary fill (optional)</div>
      <div class="small" style="margin-top:6px;">
        Note: planned sites / demand centroids are planning layers — keep them in Planner view.
      </div>
    </div>
  </div>

  <script>
    // ====== PUT YOUR KEY HERE ======
    const GMAPS_KEY = "AIzaSyAUproFl8jRStUlFwOKbQ8yh2CjNJ_H2c4";

    // Driver view loads only LSOA (for Cardiff bounds) + supply chargers
    const BASE = new URL("./", window.location.href);
    const DATA_URLS = {
      lsoa:   new URL("data/processed/demand_lsoa_cardiff_exact.geojson", BASE).href,
      supply: new URL("data/processed/supply_chargers_ocm.geojson", BASE).href
    };

    // fallback Cardiff bbox (used before LSOA bounds computed)
    const FALLBACK_CARDIFF = { north: 51.566, south: 51.410, east: -3.065, west: -3.335 };

    // map globals
    let map, info, trafficLayer, lsoaLayer;
    let supplyMarkers = [];
    let originMarker = null;
    let originLatLng = null;

    let directionsService, directionsRenderer, distanceMatrixService;

    let cardiffBoundsLiteral = null;
    let cardiffBoundsObj = null;
    let lockListener = null;

    let sortMode = "eta"; // "eta" | "dist"
    let lastResults = [];

    // Icons (MUST be created AFTER google exists => inside initMap)
    let ICON_SUPPLY_NORMAL = null;
    let ICON_SUPPLY_HOVER  = null;

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    async function loadGeoJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status}  ${url}`);
      return await res.json();
    }

    function setMarkersVisible(markers, on) {
      for (const m of markers) m.setMap(on ? map : null);
    }

    function insideCardiffLatLng(latlng){
      const b = cardiffBoundsLiteral || FALLBACK_CARDIFF;
      return latlng.lat() <= b.north && latlng.lat() >= b.south && latlng.lng() >= b.west && latlng.lng() <= b.east;
    }

    function applyCardiffLock(on){
      if(lockListener){
        google.maps.event.removeListener(lockListener);
        lockListener = null;
      }
      if(!on){
        map.setOptions({ restriction: null });
        return;
      }
      if(!cardiffBoundsObj){
        cardiffBoundsObj = new google.maps.LatLngBounds(
          new google.maps.LatLng(FALLBACK_CARDIFF.south, FALLBACK_CARDIFF.west),
          new google.maps.LatLng(FALLBACK_CARDIFF.north, FALLBACK_CARDIFF.east)
        );
        cardiffBoundsLiteral = {...FALLBACK_CARDIFF};
      }
      map.setOptions({
        restriction: {
          latLngBounds: cardiffBoundsObj,
          strictBounds: true
        }
      });
      lockListener = map.addListener("dragend", () => {
        if(!cardiffBoundsObj.contains(map.getCenter())){
          map.fitBounds(cardiffBoundsObj);
        }
      });
    }

    function fitBoundsFromGeoJSONPolygon(geojson) {
      const bounds = new google.maps.LatLngBounds();
      let added = 0;

      function addCoord(lng, lat) {
        if (typeof lat !== "number" || typeof lng !== "number") return;
        if (!isFinite(lat) || !isFinite(lng)) return;
        if (lat < -85 || lat > 85) return;
        if (lng < -180 || lng > 180) return;
        bounds.extend({ lat, lng });
        added++;
      }

      for (const f of (geojson.features || [])) {
        const g = f.geometry;
        if (!g) continue;

        if (g.type === "Polygon") {
          for (const ring of g.coordinates || []) {
            for (const [lng, lat] of ring || []) addCoord(lng, lat);
          }
        } else if (g.type === "MultiPolygon") {
          for (const poly of g.coordinates || []) {
            for (const ring of poly || []) {
              for (const [lng, lat] of ring || []) addCoord(lng, lat);
            }
          }
        }
      }

      if (added > 10) {
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        cardiffBoundsLiteral = { north: ne.lat(), south: sw.lat(), east: ne.lng(), west: sw.lng() };
        cardiffBoundsObj = bounds;
        map.fitBounds(bounds);
        return true;
      }
      return false;
    }

    function setOrigin(latlng, label){
      originLatLng = latlng;
      if(originMarker) originMarker.setMap(null);

      originMarker = new google.maps.Marker({
        position: latlng,
        title: label || "Origin",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: "#111827",
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeOpacity: 1,
          strokeWeight: 3,
          scale: 7
        },
        zIndex: google.maps.Marker.MAX_ZINDEX + 2
      });
      originMarker.setMap(map);

      setStatus(`Origin set:\n${label || `${latlng.lat().toFixed(5)}, ${latlng.lng().toFixed(5)}`}\n\nClick “Recommend best chargers (ETA)” to rank.`);
    }

    function initLayersUI(){
      const lyTraffic = document.getElementById("lyTraffic");
      const lySupply  = document.getElementById("lySupply");
      const lyLSOA    = document.getElementById("lyLSOA");

      lyTraffic.addEventListener("change", () => trafficLayer.setMap(lyTraffic.checked ? map : null));
      lySupply.addEventListener("change",  () => setMarkersVisible(supplyMarkers, lySupply.checked));
      lyLSOA.addEventListener("change",    () => lsoaLayer.setMap(lyLSOA.checked ? map : null));
    }

    function makeSupplyMarkers(geojson){
      const feats = geojson.features || [];
      const markers = [];

      for(const f of feats){
        if(!f.geometry || f.geometry.type !== "Point") continue;
        const [lng, lat] = f.geometry.coordinates || [];
        if(typeof lat !== "number" || typeof lng !== "number") continue;

        const name =
          (f.properties && (
            f.properties.name ||
            f.properties.operator ||
            f.properties.location ||
            f.properties.Address ||
            f.properties.address ||
            f.properties.Site ||
            f.properties.site
          )) || "Charger";

        const m = new google.maps.Marker({
          position: {lat,lng},
          icon: ICON_SUPPLY_NORMAL,
          title: name,
          zIndex: 1000,
          optimized: true
        });

        // hover: larger + clear tooltip
        m.addListener("mouseover", () => {
          m.setIcon(ICON_SUPPLY_HOVER);
          m.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
          info.setContent(`<b>${escapeHtml(name)}</b>`);
          info.open(map, m);
        });
        m.addListener("mouseout", () => {
          m.setIcon(ICON_SUPPLY_NORMAL);
          m.setZIndex(1000);
          info.close();
        });

        // click: set destination and hint to recommend
        m.addListener("click", () => {
          info.setContent(`<b>${escapeHtml(name)}</b><br/>Destination highlighted.<br/>Click “Recommend” to compare ETAs.`);
          info.open(map, m);
        });

        m.setMap(map);
        markers.push(m);
      }
      return markers;
    }

    function renderResults(items){
      const list = document.getElementById("list");
      const count = document.getElementById("count");
      count.textContent = String(items.length);

      list.innerHTML = "";
      if(!items.length){
        list.innerHTML = `
          <div class="item" style="cursor:default;">
            <div class="name">No results yet.</div>
            <div class="meta">Set origin (search / my location / click map) → Recommend.</div>
          </div>`;
        return;
      }

      for(const it of items){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="itemTop">
            <div>
              <div class="name">${escapeHtml(it.name)}</div>
              <div class="meta">Distance: ${escapeHtml(it.distanceText)} · Normal: ${escapeHtml(it.durationText)}</div>
              <div class="meta"><b>ETA (traffic): ${escapeHtml(it.trafficText)}</b> · Delay: ${escapeHtml(it.delayText)}</div>
            </div>
            <div class="pill">${escapeHtml(it.rankLabel)}</div>
          </div>
        `;

        div.addEventListener("click", () => {
          drawRoute(originLatLng, it.latlng, it.name);
        });

        list.appendChild(div);
      }
    }

    function setSortButtons(){
      document.getElementById("sortEta").classList.toggle("active", sortMode === "eta");
      document.getElementById("sortDist").classList.toggle("active", sortMode === "dist");
    }

    function applySortAndRender(){
      if(!lastResults.length){
        renderResults([]);
        return;
      }
      const items = [...lastResults];
      if(sortMode === "eta"){
        items.sort((a,b) => a.trafficValue - b.trafficValue);
      }else{
        items.sort((a,b) => a.distanceValue - b.distanceValue);
      }
      items.forEach((x,i) => x.rankLabel = `#${i+1}`);
      renderResults(items);
    }

    function msToText(sec){
      const m = Math.round(sec/60);
      if(m < 60) return `${m} min`;
      const h = Math.floor(m/60);
      const r = m % 60;
      return `${h} h ${r} min`;
    }

    async function recommendTop5(){
      if(!originLatLng){
        setStatus("Please set an origin first (Search / Use my location / click on map).");
        return;
      }
      if(!supplyMarkers.length){
        setStatus("No charger points loaded.");
        return;
      }

      setStatus("Computing Top 5 by ETA (traffic)…");

      // prefilter by straight-line distance (fast)
      const candidates = supplyMarkers
        .map(m => {
          const p = m.getPosition();
          const d = google.maps.geometry.spherical.computeDistanceBetween(originLatLng, p);
          return { marker: m, latlng: p, name: m.getTitle() || "Charger", approxDist: d };
        })
        .sort((a,b) => a.approxDist - b.approxDist)
        .slice(0, 25);

      const destinations = candidates.map(c => c.latlng);

      const request = {
        origins: [originLatLng],
        destinations,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: {
          departureTime: new Date(),
          trafficModel: google.maps.TrafficModel.BEST_GUESS
        },
        unitSystem: google.maps.UnitSystem.METRIC
      };

      const res = await new Promise((resolve, reject) => {
        distanceMatrixService.getDistanceMatrix(request, (r, status) => {
          if(status !== "OK" || !r) return reject(new Error("DistanceMatrix failed: " + status));
          resolve(r);
        });
      });

      const el = res.rows?.[0]?.elements || [];
      const items = [];

      for(let i=0;i<el.length;i++){
        const e = el[i];
        if(!e || e.status !== "OK") continue;

        const distVal = e.distance?.value ?? Infinity;
        const distText = e.distance?.text ?? "(n/a)";

        const durVal = e.duration?.value ?? Infinity;
        const durText = e.duration?.text ?? "(n/a)";

        const trafVal = e.duration_in_traffic?.value ?? durVal;
        const trafText = e.duration_in_traffic?.text ?? durText;

        const delaySec = Math.max(0, trafVal - durVal);
        const delayText = delaySec > 30 ? `+${msToText(delaySec)}` : "+0 min";

        items.push({
          name: candidates[i].name,
          latlng: candidates[i].latlng,
          distanceValue: distVal,
          distanceText: distText,
          durationValue: durVal,
          durationText: durText,
          trafficValue: trafVal,
          trafficText: trafText,
          delayText,
          rankLabel: ""
        });
      }

      items.sort((a,b) => a.trafficValue - b.trafficValue);
      const top5 = items.slice(0, 5);
      top5.forEach((x,i) => x.rankLabel = `#${i+1}`);

      lastResults = top5;
      setStatus(`Loaded.\nExisting chargers: ${supplyMarkers.length}\nTop 5 computed (traffic-aware ETA).`);
      applySortAndRender();
    }

    function drawRoute(origin, dest, destName){
      if(!origin || !dest) return;

      setStatus("Routing with traffic…");
      directionsService.route({
        origin,
        destination: dest,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: {
          departureTime: new Date(),
          trafficModel: google.maps.TrafficModel.BEST_GUESS
        }
      }, (result, status) => {
        if(status !== "OK" || !result){
          setStatus("Route failed: " + status);
          return;
        }
        directionsRenderer.setDirections(result);

        const leg = result.routes[0].legs[0];
        const durTraffic = leg.duration_in_traffic ? leg.duration_in_traffic.text : "(n/a)";
        const durNormal  = leg.duration ? leg.duration.text : "(n/a)";
        setStatus(`Route preview → ${destName || "destination"}\nETA (traffic): ${durTraffic}\nNormal: ${durNormal}\nDistance: ${leg.distance?.text || "(n/a)"}`);
      });
    }

    // ===== SEARCH: no need to type "Cardiff" manually =====
    async function geocodeRequest(query, useBoundsBias){
      const b = cardiffBoundsLiteral || FALLBACK_CARDIFF;
      const boundsParam = `${b.south},${b.west}|${b.north},${b.east}`;

      const params = new URLSearchParams();
      params.set("address", query);
      params.set("key", GMAPS_KEY);
      params.set("region", "uk");
      params.set("components", "country:GB");
      if(useBoundsBias) params.set("bounds", boundsParam);

      const url = `https://maps.googleapis.com/maps/api/geocode/json?${params.toString()}`;
      const res = await fetch(url);
      const data = await res.json();

      if(data.status !== "OK"){
        throw new Error(`${data.status}${data.error_message ? (": " + data.error_message) : ""}`);
      }
      return data.results || [];
    }

    async function geocodeSmart(query){
      // 1) normal geocode first
      let results = await geocodeRequest(query, false);
      for(const r of results){
        const loc = r.geometry.location;
        const ll = new google.maps.LatLng(loc.lat, loc.lng);
        if(insideCardiffLatLng(ll)){
          return { latlng: ll, formatted: r.formatted_address || query, inside: true };
        }
      }

      // 2) Cardiff bounds bias
      results = await geocodeRequest(query, true);
      for(const r of results){
        const loc = r.geometry.location;
        const ll = new google.maps.LatLng(loc.lat, loc.lng);
        if(insideCardiffLatLng(ll)){
          return { latlng: ll, formatted: r.formatted_address || query, inside: true };
        }
      }

      // 3) if unlocked, accept first result even outside
      const unlock = document.getElementById("unlock").checked;
      if(unlock && results.length){
        const loc = results[0].geometry.location;
        const ll = new google.maps.LatLng(loc.lat, loc.lng);
        return { latlng: ll, formatted: results[0].formatted_address || query, inside: false };
      }

      throw new Error("No matching result inside Cardiff. Enable “Unlock map” to search outside Cardiff.");
    }

    // ===== initMap: ONLY place we touch google.* at top-level =====
    async function initMap(){
      // create icons AFTER google is ready
      ICON_SUPPLY_NORMAL = {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: "#2563eb",
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeOpacity: 1,
        strokeWeight: 3,
        scale: 9
      };
      ICON_SUPPLY_HOVER = {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: "#1d4ed8",
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeOpacity: 1,
        strokeWeight: 4,
        scale: 11
      };

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 51.4816, lng: -3.1791 },
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });

      info = new google.maps.InfoWindow();

      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      lsoaLayer = new google.maps.Data();
      lsoaLayer.setStyle({
        fillColor: "#93c5fd",
        fillOpacity: 0.20,
        strokeColor: "#2563eb",
        strokeOpacity: 0.75,
        strokeWeight: 1
      });
      lsoaLayer.setMap(null); // off by default in driver view

      directionsService  = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });
      distanceMatrixService = new google.maps.DistanceMatrixService();

      initLayersUI();

      // default: lock on
      applyCardiffLock(true);

      try{
        setStatus("Loading data…");

        const [lsoa, supply] = await Promise.all([
          loadGeoJSON(DATA_URLS.lsoa),
          loadGeoJSON(DATA_URLS.supply)
        ]);

        lsoaLayer.addGeoJson(lsoa);

        const ok = fitBoundsFromGeoJSONPolygon(lsoa);
        if(!ok){
          cardiffBoundsLiteral = {...FALLBACK_CARDIFF};
          cardiffBoundsObj = new google.maps.LatLngBounds(
            new google.maps.LatLng(FALLBACK_CARDIFF.south, FALLBACK_CARDIFF.west),
            new google.maps.LatLng(FALLBACK_CARDIFF.north, FALLBACK_CARDIFF.east)
          );
          map.fitBounds(cardiffBoundsObj);
        }

        applyCardiffLock(!document.getElementById("unlock").checked);

        supplyMarkers = makeSupplyMarkers(supply);

        setStatus(`Loaded.\nExisting chargers: ${(supply.features||[]).length}\n\nSet origin then Recommend.`);
      }catch(err){
        console.error(err);
        setStatus("FAILED.\n" + String(err));
        alert(String(err));
      }

      // click map to set origin (fallback)
      map.addListener("click", (e) => {
        const unlock = document.getElementById("unlock").checked;
        if(!unlock && !insideCardiffLatLng(e.latLng)){
          setStatus("Origin must be inside Cardiff (toggle Unlock to allow outside).");
          return;
        }
        setOrigin(e.latLng, "Origin (clicked)");
      });

      // unlock toggle
      document.getElementById("unlock").addEventListener("change", (e) => {
        applyCardiffLock(!e.target.checked);
        setStatus(e.target.checked ? "Map unlocked." : "Map locked to Cardiff bounds.");
      });

      // search
      document.getElementById("btnSearch").addEventListener("click", async () => {
        const q = (document.getElementById("q").value || "").trim();
        if(!q){
          setStatus("Type an address/place to search.");
          return;
        }
        try{
          setStatus("Searching…");
          const r = await geocodeSmart(q);
          const unlock = document.getElementById("unlock").checked;

          if(!unlock && !r.inside){
            setStatus("Result is outside Cardiff. Enable “Unlock map” to go there.");
            return;
          }

          map.panTo(r.latlng);
          map.setZoom(14);
          setOrigin(r.latlng, r.formatted);
        }catch(err){
          console.error(err);
          setStatus("Search failed. Try a more specific address or postcode.\n\n" + String(err));
          alert(String(err));
        }
      });

      document.getElementById("q").addEventListener("keydown", (e) => {
        if(e.key === "Enter") document.getElementById("btnSearch").click();
      });

      // my location
      document.getElementById("btnMyLoc").addEventListener("click", () => {
        setStatus("Getting your location…");
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const ll = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            const unlock = document.getElementById("unlock").checked;

            if(!unlock && !insideCardiffLatLng(ll)){
              setStatus("Your location is outside Cardiff. Enable Unlock to use it.");
              return;
            }

            map.panTo(ll);
            map.setZoom(14);
            setOrigin(ll, "Origin (my location)");
          },
          (err) => {
            console.error(err);
            setStatus("Geolocation denied/unavailable.\nClick on map to set origin.");
            alert("Cannot access location: " + err.message);
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });

      // recommend
      document.getElementById("btnRecommend").addEventListener("click", async () => {
        try{
          await recommendTop5();
        }catch(err){
          console.error(err);
          setStatus("Recommend failed.\n" + String(err));
          alert(String(err));
        }
      });

      // sorting
      document.getElementById("sortEta").addEventListener("click", () => {
        sortMode = "eta";
        setSortButtons();
        applySortAndRender();
      });
      document.getElementById("sortDist").addEventListener("click", () => {
        sortMode = "dist";
        setSortButtons();
        applySortAndRender();
      });
      setSortButtons();
    }

    window.initMap = initMap;

    // Load Maps JS (geometry needed)
    (function loadGoogleMaps(){
      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&callback=initMap&v=weekly&libraries=geometry`;
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
