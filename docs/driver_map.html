<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cardiff EV Charging – P=10 + Live Traffic</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    /* IMPORTANT: prevent global CSS from breaking Google tiles */
    #map img { max-width: none !important; }

    .panel{
      position:absolute; top:12px; left:12px; z-index:5;
      background:rgba(255,255,255,0.96);
      border:1px solid #ddd; border-radius:10px;
      padding:10px 12px; width:340px;
      box-shadow:0 4px 18px rgba(0,0,0,0.12);
    }
    .panel h3{ margin:6px 0 8px; font-size:14px; }
    .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .row input{ transform: translateY(1px); }
    .legend{ margin-top:10px; font-size:12px; line-height:1.35; }
    .swatch{ display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:6px; border:1px solid rgba(0,0,0,0.2); }
    .btn{
      display:inline-block; margin-top:8px;
      background:#111827; color:#fff; border:none; border-radius:8px;
      padding:8px 10px; cursor:pointer; font-size:12px;
    }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .small{ color:#374151; font-size:12px; }
    .status{ margin-top:6px; font-size:12px; color:#111827; white-space:pre-wrap; }
    .hint{ margin-top:6px; font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Layers</h3>
    <div class="row"><input id="lyTraffic" type="checkbox" checked><label for="lyTraffic">Live traffic</label></div>
    <div class="row"><input id="lyLSOA" type="checkbox" checked><label for="lyLSOA">LSOA polygons (Cardiff)</label></div>
    <div class="row"><input id="lySupply" type="checkbox" checked><label for="lySupply">Existing chargers (OCM)</label></div>
    <div class="row"><input id="lyNew" type="checkbox" checked><label for="lyNew">New sites selected (P=10)</label></div>
    <div class="row"><input id="lyDemand" type="checkbox"><label for="lyDemand">Demand centroids (LSOA)</label></div>

    <h3 style="margin-top:10px;">Driver demo (optional)</h3>
    <div class="small">Click a blue/red marker → set destination → “Route with traffic”.</div>
    <button id="btnRoute" class="btn" disabled>Route with traffic (from my location)</button>
    <div id="status" class="status"></div>
    <div class="hint">Tip: traffic lines are clearer at zoom ≥ 11–12.</div>

    <div class="legend">
      <b>Legend</b><br/>
      <div><span class="swatch" style="background:#2563eb;"></span>Blue circles: existing chargers</div>
      <div><span class="swatch" style="background:#ef4444;"></span>Red arrows: new sites (P=10)</div>
      <div><span class="swatch" style="background:#6b7280;"></span>Grey dots: demand centroids</div>
      <div style="margin-top:6px;"><span class="swatch" style="background:#93c5fd;"></span>LSOA boundary fill</div>
    </div>
  </div>

  <script>
    // ====== PUT YOUR KEY HERE ======
    const GMAPS_KEY = "AIzaSyAUproFl8jRStUlFwOKbQ8yh2CjNJ_H2c4";

    const BASE = new URL("./", window.location.href);
    const DATA_URLS = {
      lsoa:   new URL("data/processed/demand_lsoa_cardiff_exact.geojson", BASE).href,
      demand: new URL("data/processed/demand_points_cardiff_exact.geojson", BASE).href,
      supply: new URL("data/processed/supply_chargers_ocm.geojson", BASE).href,
      news:   new URL("data/processed/new_sites_p10.geojson", BASE).href
    };

    let map, info, trafficLayer, lsoaLayer;
    let supplyMarkers = [], demandMarkers = [], newMarkers = [];
    let selectedDestination = null;

    let directionsService, directionsRenderer;

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    async function loadGeoJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status}  ${url}`);
      return await res.json();
    }

    function setMarkersVisible(markers, on) {
      for (const m of markers) m.setMap(on ? map : null);
    }

    function circleSymbol(fillColor, scale) {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor,
        fillOpacity: 0.95,
        strokeColor: "#ffffff",
        strokeOpacity: 1,
        strokeWeight: 1,
        scale
      };
    }

    function addPointMarkers(geojson, kind) {
      const feats = geojson.features || [];
      const markers = [];

      for (const f of feats) {
        if (!f.geometry || f.geometry.type !== "Point") continue;
        const [lng, lat] = f.geometry.coordinates || [];
        if (typeof lat !== "number" || typeof lng !== "number") continue;

        let marker = null;

        if (kind === "supply") {
          marker = new google.maps.Marker({
            position: { lat, lng },
            icon: circleSymbol("#2563eb", 6),
            title: "Existing charger"
          });
          marker.addListener("click", () => {
            selectedDestination = marker.getPosition();
            info.setContent(`<b>Existing charger</b><br/>Destination set.`);
            info.open(map, marker);
            document.getElementById("btnRoute").disabled = false;
          });
        }

        if (kind === "new") {
          const sid = (f.properties && (f.properties.site_id || f.properties.id || f.properties.chosen_candidate_id)) || "";
          marker = new google.maps.Marker({
            position: { lat, lng },
            icon: {
              path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
              fillColor: "#ef4444",
              fillOpacity: 0.95,
              strokeColor: "#ffffff",
              strokeWeight: 1,
              scale: 7
            },
            title: `NEW site (P=10) ${sid}`.trim()
          });
          marker.addListener("click", () => {
            selectedDestination = marker.getPosition();
            info.setContent(`<b>NEW site (P=10)</b><br/>id: ${sid || "(n/a)"}<br/>Destination set.`);
            info.open(map, marker);
            document.getElementById("btnRoute").disabled = false;
          });
        }

        if (kind === "demand") {
          const lsoa = (f.properties && (f.properties.LSOA21CD || f.properties.lsoa)) || "demand";
          marker = new google.maps.Marker({
            position: { lat, lng },
            icon: circleSymbol("#6b7280", 4),
            title: `Demand: ${lsoa}`
          });
        }

        if (marker) {
          marker.setMap(map);
          markers.push(marker);
        }
      }
      return markers;
    }

    function initLayersUI() {
      const lyTraffic = document.getElementById("lyTraffic");
      const lyLSOA    = document.getElementById("lyLSOA");
      const lySupply  = document.getElementById("lySupply");
      const lyNew     = document.getElementById("lyNew");
      const lyDemand  = document.getElementById("lyDemand");

      lyTraffic.addEventListener("change", () => trafficLayer.setMap(lyTraffic.checked ? map : null));
      lyLSOA.addEventListener("change", () => lsoaLayer.setMap(lyLSOA.checked ? map : null));
      lySupply.addEventListener("change", () => setMarkersVisible(supplyMarkers, lySupply.checked));
      lyNew.addEventListener("change", () => setMarkersVisible(newMarkers, lyNew.checked));
      lyDemand.addEventListener("change", () => setMarkersVisible(demandMarkers, lyDemand.checked));
    }

    // Safer bounds from GeoJSON (filters invalid coords)
    function fitBoundsFromGeoJSONPolygon(geojson) {
      const bounds = new google.maps.LatLngBounds();
      let added = 0;

      function addCoord(lng, lat) {
        if (typeof lat !== "number" || typeof lng !== "number") return;
        if (!isFinite(lat) || !isFinite(lng)) return;
        if (lat < -85 || lat > 85) return;
        if (lng < -180 || lng > 180) return;
        bounds.extend({ lat, lng });
        added++;
      }

      for (const f of (geojson.features || [])) {
        const g = f.geometry;
        if (!g) continue;

        if (g.type === "Polygon") {
          for (const ring of g.coordinates || []) {
            for (const [lng, lat] of ring || []) addCoord(lng, lat);
          }
        } else if (g.type === "MultiPolygon") {
          for (const poly of g.coordinates || []) {
            for (const ring of poly || []) {
              for (const [lng, lat] of ring || []) addCoord(lng, lat);
            }
          }
        }
      }

      console.log("Bounds points added:", added);
      if (added > 10) {
        map.fitBounds(bounds);
        return true;
      }
      return false;
    }

    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 51.4816, lng: -3.1791 },
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });

      // DEBUG marker (you MUST see this)
      new google.maps.Marker({
        position: { lat: 51.4816, lng: -3.1791 },
        title: "DEBUG: Cardiff center"
      }).setMap(map);

      info = new google.maps.InfoWindow();

      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      lsoaLayer = new google.maps.Data();
      lsoaLayer.setStyle({
        fillColor: "#93c5fd",
        fillOpacity: 0.25,
        strokeColor: "#2563eb",
        strokeOpacity: 0.95,
        strokeWeight: 2
      });
      lsoaLayer.setMap(map);

      directionsService  = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });

      initLayersUI();

      try {
        setStatus(
          "Loading GeoJSON...\n" +
          Object.entries(DATA_URLS).map(([k,v]) => `${k}: ${v}`).join("\n")
        );

        const [lsoa, demand, supply, news] = await Promise.all([
          loadGeoJSON(DATA_URLS.lsoa),
          loadGeoJSON(DATA_URLS.demand),
          loadGeoJSON(DATA_URLS.supply),
          loadGeoJSON(DATA_URLS.news),
        ]);

        // Add polygons
        lsoaLayer.addGeoJson(lsoa);

        // SAFER fitBounds
        const ok = fitBoundsFromGeoJSONPolygon(lsoa);
        if (!ok) {
          // fallback
          map.setCenter({ lat: 51.4816, lng: -3.1791 });
          map.setZoom(11);
        }

        // Markers
        supplyMarkers = addPointMarkers(supply, "supply");
        newMarkers    = addPointMarkers(news, "new");
        demandMarkers = addPointMarkers(demand, "demand");
        setMarkersVisible(demandMarkers, false);

        setStatus(
          `Loaded.\n` +
          `LSOA features: ${(lsoa.features||[]).length}\n` +
          `Supply points: ${(supply.features||[]).length}\n` +
          `New points: ${(news.features||[]).length}\n` +
          `Demand points: ${(demand.features||[]).length}\n\n` +
          `If you only see blank: check adblock/network tiles.\n`
        );
      } catch (err) {
        console.error(err);
        setStatus("FAILED.\n" + String(err));
        alert(String(err));
      }

      document.getElementById("btnRoute").addEventListener("click", () => {
        if (!selectedDestination) return;

        setStatus("Getting your location…");
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            setStatus("Routing with traffic…");

            directionsService.route({
              origin,
              destination: selectedDestination,
              travelMode: google.maps.TravelMode.DRIVING,
              drivingOptions: {
                departureTime: new Date(),
                trafficModel: google.maps.TrafficModel.BEST_GUESS
              }
            }, (result, status) => {
              if (status !== "OK" || !result) {
                setStatus("Route failed: " + status);
                return;
              }
              directionsRenderer.setDirections(result);

              const leg = result.routes[0].legs[0];
              const durTraffic = leg.duration_in_traffic ? leg.duration_in_traffic.text : "(n/a)";
              setStatus(`ETA (traffic): ${durTraffic} | Distance: ${leg.distance.text}`);
            });
          },
          (err) => {
            setStatus("Geolocation denied/unavailable.");
            alert("Cannot access location: " + err.message);
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    window.initMap = initMap;

    (function loadGoogleMaps() {
      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&callback=initMap&v=weekly`;
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
