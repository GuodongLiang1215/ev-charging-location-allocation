<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cardiff EV Driver – Chargers + Live Traffic</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    #map img { max-width: none !important; }

    .panel{
      position:absolute; top:12px; left:12px; z-index:5;
      background:rgba(255,255,255,0.96);
      border:1px solid #ddd; border-radius:10px;
      padding:10px 12px; width:360px;
      box-shadow:0 4px 18px rgba(0,0,0,0.12);
    }
    .panel h3{ margin:6px 0 8px; font-size:14px; }
    .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .row input{ transform: translateY(1px); }

    .searchRow{ display:flex; gap:8px; margin:8px 0; }
    .searchRow input{
      flex:1; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; font-size:12px;
    }
    .btn{
      background:#111827; color:#fff; border:none; border-radius:8px;
      padding:8px 10px; cursor:pointer; font-size:12px;
    }
    .btn.secondary{ background:#374151; }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .small{ color:#374151; font-size:12px; }
    .status{ margin-top:6px; font-size:12px; color:#111827; white-space:pre-wrap; }
    .hint{ margin-top:6px; font-size:12px; color:#6b7280; }

    .listBox{
      margin-top:10px;
      border-top:1px solid #e5e7eb;
      padding-top:10px;
      max-height: 260px;
      overflow:auto;
    }
    .listHeader{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      font-size:12px; color:#111827; margin-bottom:6px;
    }
    .pill{
      border:1px solid #d1d5db;
      padding:6px 8px;
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      font-size:12px;
    }
    .pill.active{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .item{
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:8px 10px;
      margin:6px 0;
      cursor:pointer;
      background:#fff;
    }
    .item:hover{ border-color:#cbd5e1; }
    .itemTitle{ font-size:12px; font-weight:600; margin-bottom:4px; }
    .itemMeta{ font-size:12px; color:#374151; display:flex; gap:10px; flex-wrap:wrap; }
    .badge{
      display:inline-block;
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#eef2ff;
      color:#1e3a8a;
      border:1px solid #c7d2fe;
      margin-left:6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Driver view (Cardiff only)</h3>

    <div class="searchRow">
      <input id="searchInput" placeholder="Search an address/place in Cardiff (e.g., Cardiff Castle)" />
      <button id="btnSearch" class="btn">Search</button>
    </div>

    <div class="row">
      <button id="btnMyLoc" class="btn secondary">Use my location</button>
      <button id="btnRecommend" class="btn" disabled>Recommend best chargers (ETA)</button>
    </div>

    <div class="row"><input id="lyTraffic" type="checkbox" checked><label for="lyTraffic">Live traffic</label></div>
    <div class="row"><input id="lySupply" type="checkbox" checked><label for="lySupply">Existing chargers</label></div>

    <div id="status" class="status"></div>
    <div class="hint">Tip: traffic lines are clearer at zoom ≥ 12. You can’t pan outside Cardiff.</div>

    <div class="listBox">
      <div class="listHeader">
        <div><b>Best options</b> <span class="badge" id="countBadge">0</span></div>
        <div>
          <span id="sortETA" class="pill active">Sort: ETA</span>
          <span id="sortDist" class="pill">Sort: Distance</span>
        </div>
      </div>
      <div id="results"></div>
    </div>
  </div>

  <script>
    const GMAPS_KEY = "AIzaSyAUproFl8jRStUlFwOKbQ8yh2CjNJ_H2c4";

    // Cardiff bounds (approx)
    const CARDIFF_BOUNDS = { south: 51.35, west: -3.44, north: 51.64, east: -2.94 };
    const CARDIFF_CENTER = { lat: 51.4816, lng: -3.1791 };

    // Data path (GitHub Pages friendly)
    const BASE = new URL("./", window.location.href);
    const DATA_URLS = {
      supply: new URL("data/processed/supply_chargers_ocm.geojson", BASE).href
    };

    // How many chargers to evaluate for ETA ranking
    const TOP_N_CANDIDATES = 8;

    let map, info, trafficLayer;
    let supplyMarkers = [];
    let originMarker = null;
    let originLatLng = null;

    let directionsService, distanceMatrixService, geocoder, placesService;
    let directionsRenderer = null;

    let lastRanked = []; // store ranked results for sorting

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function inCardiff(lat, lng) {
      return lat >= CARDIFF_BOUNDS.south && lat <= CARDIFF_BOUNDS.north &&
             lng >= CARDIFF_BOUNDS.west  && lng <= CARDIFF_BOUNDS.east;
    }

    async function loadGeoJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${url}`);
      return await res.json();
    }

    function circleSymbol(fillColor, scale) {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor,
        fillOpacity: 0.95,
        strokeColor: "#ffffff",
        strokeOpacity: 1,
        strokeWeight: 2,     // ✅ thicker border
        scale                // ✅ bigger
      };
    }

    function setMarkersVisible(markers, on) {
      for (const m of markers) m.setMap(on ? map : null);
    }

    function clearRoute() {
      if (directionsRenderer) directionsRenderer.setMap(null);
      directionsRenderer = null;
    }

    function setOrigin(latLng, label) {
      originLatLng = latLng;

      if (originMarker) originMarker.setMap(null);
      originMarker = new google.maps.Marker({
        position: latLng,
        title: label || "Start",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: "#111827",
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 2,
          scale: 7
        }
      });
      originMarker.setMap(map);

      map.panTo(latLng);
      if (map.getZoom() < 13) map.setZoom(13);

      document.getElementById("btnRecommend").disabled = false;
      setStatus(`Origin set: ${label || "custom location"}`);
      clearRoute();
    }

    function addSupplyMarkers(geojson) {
      const feats = geojson.features || [];
      const markers = [];

      for (const f of feats) {
        if (!f.geometry || f.geometry.type !== "Point") continue;
        const [lng, lat] = f.geometry.coordinates || [];
        if (typeof lat !== "number" || typeof lng !== "number") continue;
        if (!inCardiff(lat, lng)) continue;

        const name = (f.properties && (f.properties.name || f.properties.Title || f.properties.operator)) || "Charger";
        const id = (f.properties && (f.properties.id || f.properties.ID || f.properties.OCM_ID)) || "";

        const marker = new google.maps.Marker({
          position: { lat, lng },
          icon: circleSymbol("#2563eb", 8),   // ✅ much more obvious
          title: `${name}${id ? " ("+id+")" : ""}`
        });

        marker.__meta = { name, id };

        marker.addListener("click", () => {
          info.setContent(`<b>${name}</b><br/>${id ? "ID: "+id+"<br/>" : ""}Click “Recommend best chargers (ETA)” to compare.`);
          info.open(map, marker);
        });

        marker.setMap(map);
        markers.push(marker);
      }

      return markers;
    }

    function haversineMeters(a, b) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(b.lat() - a.lat());
      const dLng = toRad(b.lng() - a.lng());
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const c = s1*s1 + Math.cos(toRad(a.lat())) * Math.cos(toRad(b.lat())) * s2*s2;
      return 2 * R * Math.asin(Math.sqrt(c));
    }

    function renderList(items) {
      const box = document.getElementById("results");
      const badge = document.getElementById("countBadge");
      badge.textContent = String(items.length);

      box.innerHTML = "";
      if (!items.length) {
        box.innerHTML = `<div class="small">No results yet. Set origin → Recommend.</div>`;
        return;
      }

      for (const it of items) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="itemTitle">${it.rank}. ${it.name}</div>
          <div class="itemMeta">
            <span><b>ETA:</b> ${it.etaText || "(n/a)"}</span>
            <span><b>Distance:</b> ${it.distText || "(n/a)"}</span>
          </div>
        `;
        div.addEventListener("click", () => {
          // draw route to selected charger (traffic-aware)
          routeTo(it.marker.getPosition(), it.name);
          map.panTo(it.marker.getPosition());
          if (map.getZoom() < 14) map.setZoom(14);
          info.setContent(`<b>${it.name}</b><br/>Selected. Route drawn (traffic-aware).`);
          info.open(map, it.marker);
        });
        box.appendChild(div);
      }
    }

    function sortAndRender(mode) {
      const sortETA = document.getElementById("sortETA");
      const sortDist = document.getElementById("sortDist");
      sortETA.classList.toggle("active", mode === "eta");
      sortDist.classList.toggle("active", mode === "dist");

      let items = [...lastRanked];
      if (mode === "dist") items.sort((a,b) => (a.distVal ?? 1e18) - (b.distVal ?? 1e18));
      else items.sort((a,b) => (a.etaVal ?? 1e18) - (b.etaVal ?? 1e18));

      // update rank numbers
      items = items.map((x, i) => ({ ...x, rank: i+1 }));
      renderList(items);
    }

    function routeTo(destLatLng, name) {
      if (!originLatLng) return;

      clearRoute();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });

      directionsService.route({
        origin: originLatLng,
        destination: destLatLng,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: {
          departureTime: new Date(),
          trafficModel: google.maps.TrafficModel.BEST_GUESS
        }
      }, (result, status) => {
        if (status !== "OK" || !result) {
          setStatus("Route failed: " + status);
          return;
        }
        directionsRenderer.setDirections(result);
        const leg = result.routes[0].legs[0];
        const durTraffic = leg.duration_in_traffic ? leg.duration_in_traffic.text : "(n/a)";
        setStatus(`Route to: ${name}\nETA (traffic): ${durTraffic} | Distance: ${leg.distance.text}`);
      });
    }

    async function recommendBest() {
      if (!originLatLng) return;

      setStatus("Selecting nearby chargers…");

      // pick closest candidates by straight-line distance first (fast filter)
      const scored = supplyMarkers.map(m => ({
        marker: m,
        name: m.__meta?.name || m.getTitle() || "Charger",
        approxM: haversineMeters(originLatLng, m.getPosition())
      })).sort((a,b) => a.approxM - b.approxM).slice(0, TOP_N_CANDIDATES);

      if (!scored.length) {
        setStatus("No chargers found in Cardiff bounds.");
        return;
      }

      setStatus(`Computing ETA (traffic) for top ${scored.length} chargers…`);

      // Use Distance Matrix with traffic
      const origins = [originLatLng];
      const destinations = scored.map(x => x.marker.getPosition());

      distanceMatrixService.getDistanceMatrix({
        origins,
        destinations,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: {
          departureTime: new Date(),
          trafficModel: google.maps.TrafficModel.BEST_GUESS
        },
        unitSystem: google.maps.UnitSystem.METRIC
      }, (resp, status) => {
        if (status !== "OK" || !resp) {
          setStatus("DistanceMatrix failed: " + status);
          return;
        }

        const row = resp.rows?.[0];
        const elements = row?.elements || [];

        const ranked = scored.map((x, i) => {
          const el = elements[i];
          const ok = el && el.status === "OK";
          const eta = ok ? (el.duration_in_traffic || el.duration) : null;
          const dist = ok ? el.distance : null;

          return {
            marker: x.marker,
            name: x.name,
            etaVal: eta ? eta.value : null,
            etaText: eta ? eta.text : null,
            distVal: dist ? dist.value : null,
            distText: dist ? dist.text : null,
            rank: i+1
          };
        });

        lastRanked = ranked;

        // default sort by ETA
        sortAndRender("eta");
        setStatus("Done. Click an item to draw route.");
      });
    }

    function initUI() {
      document.getElementById("lyTraffic").addEventListener("change", (e) => {
        trafficLayer.setMap(e.target.checked ? map : null);
      });
      document.getElementById("lySupply").addEventListener("change", (e) => {
        setMarkersVisible(supplyMarkers, e.target.checked);
      });

      document.getElementById("btnMyLoc").addEventListener("click", () => {
        setStatus("Getting your location…");
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude;
            if (!inCardiff(lat, lng)) {
              setStatus("Your location is outside Cardiff bounds (Driver view is locked).");
              return;
            }
            setOrigin(new google.maps.LatLng(lat, lng), "My location");
          },
          (err) => {
            setStatus("Geolocation denied/unavailable. Use search instead.");
            alert("Cannot access location: " + err.message);
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });

      document.getElementById("btnRecommend").addEventListener("click", recommendBest);

      document.getElementById("sortETA").addEventListener("click", () => sortAndRender("eta"));
      document.getElementById("sortDist").addEventListener("click", () => sortAndRender("dist"));

      document.getElementById("btnSearch").addEventListener("click", doSearch);
      document.getElementById("searchInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
      });
    }

    function doSearch() {
      const q = (document.getElementById("searchInput").value || "").trim();
      if (!q) return;

      setStatus("Searching…");

      // Use Places textSearch (needs "places" library)
      placesService.textSearch({
        query: q,
        location: CARDIFF_CENTER,
        radius: 15000
      }, (results, status) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results || !results.length) {
          // fallback: geocoder
          geocoder.geocode({ address: q }, (res2, st2) => {
            if (st2 !== "OK" || !res2 || !res2.length) {
              setStatus("Search failed. Try another query.");
              return;
            }
            const loc = res2[0].geometry.location;
            if (!inCardiff(loc.lat(), loc.lng())) {
              setStatus("Result is outside Cardiff. Try a Cardiff address/place.");
              return;
            }
            setOrigin(loc, res2[0].formatted_address || q);
          });
          return;
        }

        const best = results[0];
        const loc = best.geometry.location;
        if (!inCardiff(loc.lat(), loc.lng())) {
          setStatus("Result is outside Cardiff. Try a Cardiff address/place.");
          return;
        }
        setOrigin(loc, best.formatted_address || best.name || q);
      });
    }

    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: CARDIFF_CENTER,
        zoom: 12,
        minZoom: 11,
        maxZoom: 17,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        restriction: { latLngBounds: CARDIFF_BOUNDS, strictBounds: true }
      });

      info = new google.maps.InfoWindow();

      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      directionsService = new google.maps.DirectionsService();
      distanceMatrixService = new google.maps.DistanceMatrixService();
      geocoder = new google.maps.Geocoder();
      placesService = new google.maps.places.PlacesService(map);

      initUI();

      try {
        setStatus("Loading chargers…");
        const supply = await loadGeoJSON(DATA_URLS.supply);
        supplyMarkers = addSupplyMarkers(supply);
        setStatus(`Loaded chargers: ${supplyMarkers.length}\nSet origin (Search/My location) → Recommend.`);
      } catch (e) {
        console.error(e);
        setStatus("Failed to load chargers. Check console & file paths.");
        alert(String(e));
      }
    }

    window.initMap = initMap;

    (function loadGoogleMaps() {
      const s = document.createElement("script");
      // IMPORTANT: add libraries=places for search
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&callback=initMap&v=weekly&libraries=places`;
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
